<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PG Tenant Manager (Firebase + WhatsApp Manual)</title>
  <style>
    :root{font-family:Arial, sans-serif;}
    body{margin:0;background:#f6f7fb;color:#111}
    header{background:#111827;color:#fff;padding:16px}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:900px){.grid{grid-template-columns:360px 1fr}}
    h1{margin:0;font-size:18px}
    h2{margin:0 0 12px;font-size:16px}
    label{display:block;font-size:12px;margin:10px 0 6px;color:#374151}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid #d1d5db;border-radius:10px;padding:10px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#6366f1}
    button{border:0;border-radius:10px;padding:10px 12px;background:#4f46e5;color:#fff;cursor:pointer;font-weight:700}
    button.gray{background:#6b7280}
    button.danger{background:#dc2626}
    button.black{background:#111827}
    button.white{background:#fff;color:#111;border:1px solid #e5e7eb}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1;min-width:140px}
    .muted{color:#6b7280;font-size:12px}
    .hide{display:none}
    table{width:100%;border-collapse:collapse}
    th,td{text-align:left;padding:10px;border-bottom:1px solid #e5e7eb;font-size:13px;vertical-align:top}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:700;background:#eef2ff;color:#3730a3}
    .notice{background:#eff6ff;border:1px solid #bfdbfe;padding:10px;border-radius:12px;font-size:13px}
    .warn{background:#fff7ed;border:1px solid #fed7aa;padding:10px;border-radius:12px;font-size:13px}
    .ok{background:#ecfdf5;border:1px solid #bbf7d0;padding:10px;border-radius:12px;font-size:13px}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    a{color:#2563eb;text-decoration:none}
    a:hover{text-decoration:underline}
    code{background:#f3f4f6;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>PG Tenant Manager — Firebase DB + Manual WhatsApp Reminder</h1>
    <div class="muted">Cloud save (Firestore). Same data on mobile + laptop. Manual WhatsApp send with one click.</div>
  </div>
</header>

<div class="wrap grid">
  <!-- LEFT -->
  <div class="card">
    <h2>Admin Login</h2>
    <div class="notice">
      Default login: <b>admin</b> / <b>admin123</b><br/>
      Tip: Later you can change in code variables <code>ADMIN_USER</code> and <code>ADMIN_PASS</code>.
    </div>

    <label>Username</label>
    <input id="u" placeholder="admin"/>
    <label>Password</label>
    <input id="p" type="password" placeholder="admin123"/>

    <div class="row" style="margin-top:12px;">
      <button class="black" onclick="login()">Login</button>
      <button class="gray" onclick="logout()">Logout</button>
    </div>

    <hr style="border:none;border-top:1px solid #e5e7eb;margin:16px 0"/>

    <h2>Add / Edit Tenant</h2>
    <div class="warn">
      Phone format: <b>10 digits</b> (India). WhatsApp link will add <b>+91</b> automatically.
    </div>

    <input id="editId" type="hidden"/>

    <label>Tenant Name</label>
    <input id="name" placeholder="Ravi"/>

    <div class="row">
      <div>
        <label>Phone (10 digits)</label>
        <input id="phone" placeholder="9876543210"/>
      </div>
      <div>
        <label>Room</label>
        <input id="room" placeholder="A-101"/>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Sharing</label>
        <select id="sharing">
          <option>2 Sharing</option>
          <option>4 Sharing</option>
          <option>6 Sharing</option>
        </select>
      </div>
      <div>
        <label>Monthly Rent (₹)</label>
        <input id="rent" type="number" placeholder="6500"/>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Due Day (1-28)</label>
        <input id="dueDay" type="number" min="1" max="28" value="5"/>
      </div>
      <div>
        <label>Status</label>
        <select id="status">
          <option value="Active">Active</option>
          <option value="Left">Left</option>
        </select>
      </div>
    </div>

    <label>Notes (optional)</label>
    <textarea id="notes" rows="2" placeholder="Any notes..."></textarea>

    <div class="row" style="margin-top:12px;">
      <button onclick="saveTenant()">Save</button>
      <button class="white" onclick="clearForm()">Clear</button>
      <button class="danger" onclick="seedSample()">Add sample</button>
    </div>

    <div id="dbStatus" class="warn" style="margin-top:12px;">
      Connecting to database...
    </div>

    <div class="muted" style="margin-top:10px;">
      If you see permission error: Firestore Rules must be in <b>Test mode</b> currently.
    </div>
  </div>

  <!-- RIGHT -->
  <div class="card">
    <h2>Tenants List</h2>

    <div id="session" class="notice">Not logged in. (View only. Add/Edit needs admin login.)</div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Search (name/room/phone)</label>
        <input id="q" placeholder="Search..." oninput="renderTable()"/>
      </div>
      <div>
        <label>Filter</label>
        <select id="filter" onchange="renderTable()">
          <option value="All">All</option>
          <option value="Active" selected>Active</option>
          <option value="Left">Left</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>WhatsApp Message Template</label>
        <textarea id="msgTpl" rows="3"></textarea>
        <div class="muted">
          Use tokens: <span class="pill">{name}</span> <span class="pill">{room}</span> <span class="pill">{rent}</span> <span class="pill">{dueDay}</span>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="gray" onclick="refresh()">Refresh</button>
      <button class="white" onclick="exportJSON()">Export JSON</button>
      <button class="white" onclick="importJSON()">Import JSON</button>
    </div>

    <div style="overflow:auto;margin-top:10px;">
      <table id="tbl"></table>
    </div>

    <div class="muted" style="margin-top:10px;">
      WhatsApp open link works best on phone. On laptop, it opens WhatsApp Web.
    </div>
  </div>
</div>

<script type="module">
  /* ---------------- Firebase (CDN) ---------------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // Admin credentials (change if you want)
  const ADMIN_USER = "admin";
  const ADMIN_PASS = "admin123";

  // Your Firebase config (from your console)
  const firebaseConfig = {
    apiKey: "AIzaSyDc1VMtz85nJ_bV8QZ3FMMZDUJSX8qj4m0",
    authDomain: "rajarajeswaripg-7ee87.firebaseapp.com",
    projectId: "rajarajeswaripg-7ee87",
    storageBucket: "rajarajeswaripg-7ee87.firebasestorage.app",
    messagingSenderId: "790005657243",
    appId: "1:790005657243:web:17e583e139fd8cb16be03e",
    measurementId: "G-GHR6NYEGPX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const tenantsCol = collection(db, "tenants");

  /* ---------------- Local settings ---------------- */
  const LS_SESSION = "pg_admin_session_v1";
  const LS_TPL = "pg_msg_tpl_v1";

  function loadSession(){ try{return JSON.parse(localStorage.getItem(LS_SESSION))||null}catch(e){return null} }
  function saveSession(s){ localStorage.setItem(LS_SESSION, JSON.stringify(s)); }
  function clearSession(){ localStorage.removeItem(LS_SESSION); }

  function loadTpl(){
    const def = "Hi {name}, this is a rent reminder for Room {room}. Monthly rent ₹{rent}. Due date: {dueDay}. Please pay on time. Thank you.";
    return localStorage.getItem(LS_TPL) || def;
  }
  function saveTpl(v){ localStorage.setItem(LS_TPL, v); }

  function isLoggedIn(){
    const s = loadSession();
    return s && s.role==="admin";
  }

  /* ---------------- UI helpers ---------------- */
  const $ = (id)=>document.getElementById(id);
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function clamp(n,a,b){ return Math.max(a,Math.min(b,n)); }

  function setDbStatusOk(msg){
    $("dbStatus").className = "ok";
    $("dbStatus").innerHTML = "<b>Database:</b> " + esc(msg);
  }
  function setDbStatusWarn(msg){
    $("dbStatus").className = "warn";
    $("dbStatus").innerHTML = "<b>Database:</b> " + esc(msg);
  }

  /* ---------------- App state ---------------- */
  let TENANTS = []; // cached list

  /* ---------------- Auth ---------------- */
  window.login = function(){
    const u = $("u").value.trim();
    const p = $("p").value;
    if(u===ADMIN_USER && p===ADMIN_PASS){
      saveSession({role:"admin"});
      renderSession();
      alert("Logged in ✅");
    } else alert("Wrong admin login.");
  };

  window.logout = function(){
    clearSession();
    renderSession();
    alert("Logged out.");
  };

  function renderSession(){
    $("session").innerHTML = isLoggedIn()
      ? "<b>Logged in as:</b> Admin ✅"
      : "Not logged in. (View only. Add/Edit needs admin login.)";
  }

  /* ---------------- CRUD (Firestore) ---------------- */
  async function fetchTenants(){
    const snap = await getDocs(tenantsCol);
    // Sorting: latest first (client-side)
    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    list.sort((a,b)=>{
      const ta = a.createdAt?.seconds || 0;
      const tb = b.createdAt?.seconds || 0;
      return tb - ta;
    });
    TENANTS = list;
    return list;
  }

  async function addTenant(data){
    await addDoc(tenantsCol, { ...data, createdAt: serverTimestamp() });
  }

  async function updateTenant(id, data){
    await updateDoc(doc(db, "tenants", id), { ...data });
  }

  async function removeTenant(id){
    await deleteDoc(doc(db, "tenants", id));
  }

  /* ---------------- Form actions ---------------- */
  window.clearForm = function(){
    $("editId").value="";
    $("name").value="";
    $("phone").value="";
    $("room").value="";
    $("sharing").value="2 Sharing";
    $("rent").value="";
    $("dueDay").value="5";
    $("status").value="Active";
    $("notes").value="";
  };

  window.saveTenant = async function(){
    if(!isLoggedIn()){ alert("Admin login first."); return; }

    const id = $("editId").value.trim();
    const name = $("name").value.trim();
    const phone = $("phone").value.trim().replace(/\D/g,'');
    const room = $("room").value.trim();
    const sharing = $("sharing").value;
    const rent = Number($("rent").value||0);
    const dueDay = clamp(Number($("dueDay").value||5),1,28);
    const status = $("status").value;
    const notes = $("notes").value.trim();

    if(!name || phone.length!==10 || !room || !rent){
      alert("Fill Name, 10-digit Phone, Room, Rent.");
      return;
    }

    const payload = { name, phone, room, sharing, rent, dueDay, status, notes };

    try{
      if(id){
        await updateTenant(id, payload);
      } else {
        await addTenant(payload);
      }
      window.clearForm();
      await refresh();
      alert("Saved ✅");
    }catch(e){
      console.error(e);
      alert("Save failed. Check Firestore rules (test mode) or internet.");
      setDbStatusWarn("Error: " + (e?.message || e));
    }
  };

  window.editTenant = function(id){
    if(!isLoggedIn()){ alert("Admin login first."); return; }
    const t = TENANTS.find(x=>x.id===id);
    if(!t) return;
    $("editId").value=t.id;
    $("name").value=t.name || "";
    $("phone").value=t.phone || "";
    $("room").value=t.room || "";
    $("sharing").value=t.sharing || "2 Sharing";
    $("rent").value=t.rent || "";
    $("dueDay").value=t.dueDay || "5";
    $("status").value=t.status || "Active";
    $("notes").value=t.notes || "";
    window.scrollTo({top:0, behavior:"smooth"});
  };

  window.delTenant = async function(id){
    if(!isLoggedIn()){ alert("Admin login first."); return; }
    if(!confirm("Delete this tenant?")) return;
    try{
      await removeTenant(id);
      await refresh();
    }catch(e){
      console.error(e);
      alert("Delete failed. Check Firestore rules.");
      setDbStatusWarn("Error: " + (e?.message || e));
    }
  };

  /* ---------------- WhatsApp ---------------- */
  function makeMsg(t){
    const tpl = $("msgTpl").value;
    saveTpl(tpl);
    return tpl
      .replaceAll("{name}", t.name ?? "")
      .replaceAll("{room}", t.room ?? "")
      .replaceAll("{rent}", t.rent ?? "")
      .replaceAll("{dueDay}", t.dueDay ?? "");
  }

  function waLink(t){
    const phone = "91" + String(t.phone || "").replace(/\D/g,'');
    const text = encodeURIComponent(makeMsg(t));
    return `https://wa.me/${phone}?text=${text}`;
  }

  /* ---------------- Table render ---------------- */
  window.renderTable = function(){
    // template init
    const tplBox = $("msgTpl");
    if(!tplBox.value) tplBox.value = loadTpl();

    const q = ($("q").value || "").toLowerCase().trim();
    const filter = $("filter").value;

    let list = [...TENANTS];

    if(filter !== "All"){
      list = list.filter(x=> (x.status||"") === filter);
    }
    if(q){
      list = list.filter(x =>
        (x.name||"").toLowerCase().includes(q) ||
        (x.room||"").toLowerCase().includes(q) ||
        String(x.phone||"").includes(q)
      );
    }

    const tbl = $("tbl");
    if(list.length===0){
      tbl.innerHTML = `<tr><td class="muted">No tenants found. Add tenants (admin login) or click Refresh.</td></tr>`;
      return;
    }

    tbl.innerHTML = `
      <tr>
        <th>Tenant</th><th>Room</th><th>Rent</th><th>Due</th><th>Status</th><th>WhatsApp</th><th>Actions</th>
      </tr>
    `;

    list.forEach(t=>{
      tbl.innerHTML += `
        <tr>
          <td><b>${esc(t.name)}</b><div class="muted">${esc(t.phone)}<br>${esc(t.notes||"")}</div></td>
          <td>${esc(t.room)}<div class="muted">${esc(t.sharing||"")}</div></td>
          <td>₹${Number(t.rent||0).toLocaleString()}</td>
          <td>${esc(t.dueDay||"")}</td>
          <td><span class="pill">${esc(t.status||"")}</span></td>
          <td>
            <a href="${waLink(t)}" target="_blank">Open WhatsApp</a>
            <div class="muted">One-click reminder</div>
          </td>
          <td>
            <div class="actions">
              <button class="gray" onclick="editTenant('${t.id}')">Edit</button>
              <button class="danger" onclick="delTenant('${t.id}')">Delete</button>
            </div>
          </td>
        </tr>
      `;
    });
  };

  /* ---------------- Refresh / Export / Import ---------------- */
  window.refresh = async function(){
    try{
      await fetchTenants();
      setDbStatusOk("Connected ✅ Tenants loaded: " + TENANTS.length);
      renderTable();
    }catch(e){
      console.error(e);
      setDbStatusWarn("Cannot read tenants. Check Firestore rules (test mode) and internet. Error: " + (e?.message || e));
    }
  };

  window.exportJSON = function(){
    const data = JSON.stringify(TENANTS, null, 2);
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "tenants-export.json";
    a.click();
    URL.revokeObjectURL(url);
  };

  window.importJSON = async function(){
    if(!isLoggedIn()){ alert("Admin login first."); return; }

    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "application/json";
    inp.onchange = async () => {
      const file = inp.files?.[0];
      if(!file) return;
      const text = await file.text();
      let arr;
      try{ arr = JSON.parse(text); }catch(e){ alert("Invalid JSON file."); return; }

      if(!Array.isArray(arr)){ alert("JSON must be an array of tenants."); return; }
      if(!confirm("This will ADD tenants from file (it will not delete existing). Continue?")) return;

      try{
        for(const t of arr){
          const payload = {
            name: String(t.name||"").trim(),
            phone: String(t.phone||"").replace(/\D/g,''),
            room: String(t.room||"").trim(),
            sharing: t.sharing || "2 Sharing",
            rent: Number(t.rent||0),
            dueDay: clamp(Number(t.dueDay||5),1,28),
            status: t.status || "Active",
            notes: String(t.notes||"").trim(),
          };
          if(!payload.name || payload.phone.length!==10 || !payload.room || !payload.rent) continue;
          await addTenant(payload);
        }
        await refresh();
        alert("Import done ✅");
      }catch(e){
        console.error(e);
        alert("Import failed. Check Firestore rules.");
        setDbStatusWarn("Error: " + (e?.message || e));
      }
    };
    inp.click();
  };

  window.seedSample = async function(){
    if(!isLoggedIn()){ alert("Admin login first."); return; }
    if(!confirm("Add 2 sample tenants to DB?")) return;
    try{
      await addTenant({ name:"Ravi", phone:"9000000001", room:"A-101", sharing:"2 Sharing", rent:6500, dueDay:5, status:"Active", notes:"" });
      await addTenant({ name:"Sita", phone:"9000000002", room:"B-201", sharing:"4 Sharing", rent:4500, dueDay:10, status:"Active", notes:"" });
      await refresh();
    }catch(e){
      console.error(e);
      alert("Failed to add sample. Check Firestore rules.");
      setDbStatusWarn("Error: " + (e?.message || e));
    }
  };

  /* ---------------- Init ---------------- */
  renderSession();
  $("msgTpl").value = loadTpl();
  await refresh();
</script>
</body>
</html>
