<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SRI RAJARAJESWARI PG — Tenant Manager</title>
  <style>
    :root{font-family:Arial, sans-serif;}
    body{margin:0;background:#f6f7fb;color:#111}
    header{background:#111827;color:#fff;padding:16px}
    .wrap{max-width:1150px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:950px){.grid{grid-template-columns:380px 1fr}}
    h1{margin:0;font-size:18px}
    h2{margin:0 0 12px;font-size:16px}
    label{display:block;font-size:12px;margin:10px 0 6px;color:#374151}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid #d1d5db;border-radius:10px;padding:10px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#6366f1}
    button{border:0;border-radius:10px;padding:10px 12px;background:#4f46e5;color:#fff;cursor:pointer;font-weight:700}
    button.gray{background:#6b7280}
    button.danger{background:#dc2626}
    button.black{background:#111827}
    button.white{background:#fff;color:#111;border:1px solid #e5e7eb}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1;min-width:140px}
    .muted{color:#6b7280;font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{text-align:left;padding:10px;border-bottom:1px solid #e5e7eb;font-size:13px;vertical-align:top}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:700;background:#eef2ff;color:#3730a3}
    .notice{background:#eff6ff;border:1px solid #bfdbfe;padding:10px;border-radius:12px;font-size:13px}
    .warn{background:#fff7ed;border:1px solid #fed7aa;padding:10px;border-radius:12px;font-size:13px}
    .ok{background:#ecfdf5;border:1px solid #bbf7d0;padding:10px;border-radius:12px;font-size:13px}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    a{color:#2563eb;text-decoration:none}
    a:hover{text-decoration:underline}
    code{background:#f3f4f6;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>SRI RAJARAJESWARI PG — Tenant Manager (Firebase + WhatsApp + PDF Receipt)</h1>
    <div class="muted">
      Address: Hennagara Main Road, Kithaganahalli, Anekal Taluk, Bengaluru - 560099
    </div>
  </div>
</header>

<div class="wrap grid">
  <!-- LEFT -->
  <div class="card">
    <h2>Admin Login</h2>
    <div class="notice">
      Default login: <b>admin</b> / <b>admin123</b><br/>
      Change in code: <code>ADMIN_USER</code> and <code>ADMIN_PASS</code>.
    </div>

    <label>Username</label>
    <input id="u" placeholder="admin"/>
    <label>Password</label>
    <input id="p" type="password" placeholder="admin123"/>

    <div class="row" style="margin-top:12px;">
      <button class="black" onclick="login()">Login</button>
      <button class="gray" onclick="logout()">Logout</button>
    </div>

    <hr style="border:none;border-top:1px solid #e5e7eb;margin:16px 0"/>

    <h2>Add / Edit Tenant</h2>
    <div class="warn">
      Phone: <b>10 digits</b>. WhatsApp link adds <b>+91</b> automatically.
    </div>

    <input id="editId" type="hidden"/>

    <label>Tenant Name</label>
    <input id="name" placeholder="Ravi"/>

    <div class="row">
      <div>
        <label>Phone (10 digits)</label>
        <input id="phone" placeholder="9876543210"/>
      </div>
      <div>
        <label>Room</label>
        <input id="room" placeholder="A-101"/>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Sharing</label>
        <select id="sharing">
          <option>2 Sharing</option>
          <option>4 Sharing</option>
          <option>6 Sharing</option>
        </select>
      </div>
      <div>
        <label>Monthly Rent (₹)</label>
        <input id="rent" type="number" placeholder="6500"/>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Due Day (1-28)</label>
        <input id="dueDay" type="number" min="1" max="28" value="5"/>
      </div>
      <div>
        <label>Status</label>
        <select id="status">
          <option value="Active">Active</option>
          <option value="Left">Left</option>
        </select>
      </div>
    </div>

    <label>Notes (optional)</label>
    <textarea id="notes" rows="2" placeholder="Any notes..."></textarea>

    <div class="row" style="margin-top:12px;">
      <button onclick="saveTenant()">Save</button>
      <button class="white" onclick="clearForm()">Clear</button>
      <button class="danger" onclick="seedSample()">Add sample</button>
    </div>

    <div id="dbStatus" class="warn" style="margin-top:12px;">
      Connecting to database...
    </div>

    <div class="muted" style="margin-top:10px;">
      If permission error: Firestore Rules must be <b>Test mode</b> now.
    </div>

    <div class="muted" style="margin-top:10px;">
      Logo: Upload your logo file as <b>logo.png</b> in GitHub repo root.
    </div>
  </div>

  <!-- RIGHT -->
  <div class="card">
    <h2>Tenants List</h2>

    <div id="session" class="notice">Not logged in. (View only. Add/Edit/Paid/Receipt needs admin login.)</div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Search (name/room/phone)</label>
        <input id="q" placeholder="Search..." oninput="renderTable()"/>
      </div>
      <div>
        <label>Filter</label>
        <select id="filter" onchange="renderTable()">
          <option value="All">All</option>
          <option value="Active" selected>Active</option>
          <option value="Left">Left</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>WhatsApp Rent Reminder Template</label>
        <textarea id="msgTpl" rows="3"></textarea>
        <div class="muted">
          Tokens: <span class="pill">{name}</span> <span class="pill">{room}</span> <span class="pill">{rent}</span> <span class="pill">{dueDay}</span>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="gray" onclick="refresh()">Refresh</button>
      <button class="white" onclick="exportJSON()">Export JSON</button>
      <button class="white" onclick="importJSON()">Import JSON</button>
    </div>

    <div style="overflow:auto;margin-top:10px;">
      <table id="tbl"></table>
    </div>

    <div class="muted" style="margin-top:10px;">
      Receipt numbering: <b>SRRPG-YYYYMM-001</b> (monthly reset). Mark Paid → Receipt PDF → WhatsApp Receipt Msg → attach PDF.
    </div>
  </div>
</div>

<!-- jsPDF (for PDF receipts) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc,
    serverTimestamp, runTransaction, getDoc, setDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  /* ---------------- SETTINGS ---------------- */
  const PG_NAME = "SRI KOTAMMA THALLI PG FOR GENTS";
  const PG_ADDRESS = "Hennagara Main Road, Kithaganahalli, Anekal Taluk, Bengaluru - 560099";
  const LOGO_PATH = "logo.png"; // upload logo.png in repo root

  const ADMIN_USER = "admin";
  const ADMIN_PASS = "admin123";

  const firebaseConfig = {
    apiKey: "AIzaSyDc1VMtz85nJ_bV8QZ3FMMZDUJSX8qj4m0",
    authDomain: "rajarajeswaripg-7ee87.firebaseapp.com",
    projectId: "rajarajeswaripg-7ee87",
    storageBucket: "rajarajeswaripg-7ee87.firebasestorage.app",
    messagingSenderId: "790005657243",
    appId: "1:790005657243:web:17e583e139fd8cb16be03e",
    measurementId: "G-GHR6NYEGPX"
  };

  /* ---------------- Firebase init ---------------- */
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const tenantsCol = collection(db, "tenants");

  /* ---------------- Local settings ---------------- */
  const LS_SESSION = "pg_admin_session_v3";
  const LS_TPL = "pg_msg_tpl_v3";

  const $ = (id)=>document.getElementById(id);

  function loadSession(){ try{return JSON.parse(localStorage.getItem(LS_SESSION))||null}catch(e){return null} }
  function saveSession(s){ localStorage.setItem(LS_SESSION, JSON.stringify(s)); }
  function clearSession(){ localStorage.removeItem(LS_SESSION); }
  function isLoggedIn(){ const s=loadSession(); return s && s.role==="admin"; }

  function loadTpl(){
    const def = "Hi {name}, rent reminder for Room {room}. Monthly rent ₹{rent}. Due date: {dueDay}. Please pay on time. Thank you.";
    return localStorage.getItem(LS_TPL) || def;
  }
  function saveTpl(v){ localStorage.setItem(LS_TPL, v); }

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function clamp(n,a,b){ return Math.max(a,Math.min(b,n)); }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function todayDDMMYYYY(){
    const d = new Date();
    return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
  }
  function monthKey(d=new Date()){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    return `${y}${m}`;
  }
  function monthLabelFromYYYYMM(yyyymm){
    if(!yyyymm || yyyymm.length<6) return "";
    const y = yyyymm.slice(0,4);
    const m = Number(yyyymm.slice(4,6));
    const names = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return `${names[m-1] || "Month"} ${y}`;
  }

  function setDbStatusOk(msg){
    $("dbStatus").className = "ok";
    $("dbStatus").innerHTML = "<b>Database:</b> " + esc(msg);
  }
  function setDbStatusWarn(msg){
    $("dbStatus").className = "warn";
    $("dbStatus").innerHTML = "<b>Database:</b> " + esc(msg);
  }

  /* ---------------- State ---------------- */
  let TENANTS = [];

  /* ---------------- Auth (UI only) ---------------- */
  window.login = function(){
    const u = $("u").value.trim();
    const p = $("p").value;
    if(u===ADMIN_USER && p===ADMIN_PASS){
      saveSession({role:"admin"});
      renderSession();
      alert("Logged in ✅");
      renderTable();
    } else alert("Wrong admin login.");
  };

  window.logout = function(){
    clearSession();
    renderSession();
    alert("Logged out.");
    renderTable();
  };

  function renderSession(){
    $("session").innerHTML = isLoggedIn()
      ? "<b>Logged in as:</b> Admin ✅"
      : "Not logged in. (View only. Add/Edit/Paid/Receipt needs admin login.)";
  }

  /* ---------------- Firestore CRUD ---------------- */
  async function fetchTenants(){
    const snap = await getDocs(tenantsCol);
    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    list.sort((a,b)=>{
      const ta = a.createdAt?.seconds || 0;
      const tb = b.createdAt?.seconds || 0;
      return tb - ta;
    });
    TENANTS = list;
    return list;
  }

  async function addTenant(data){
    await addDoc(tenantsCol, {
      ...data,
      lastPaidYYYYMM: data.lastPaidYYYYMM || "",
      lastPaidDate: data.lastPaidDate || "",
      lastPaidMethod: data.lastPaidMethod || "",
      lastReceiptNo: data.lastReceiptNo || "",
      createdAt: serverTimestamp()
    });
  }

  async function updateTenant(id, data){
    await updateDoc(doc(db, "tenants", id), { ...data });
  }

  async function removeTenant(id){
    await deleteDoc(doc(db, "tenants", id));
  }

  /* ---------------- Monthly receipt counter (Firestore) ----------------
     counters/{YYYYMM} => { seq: number }
  */
  async function getNextReceiptNumber(yyyymm){
    const counterRef = doc(db, "counters", yyyymm);

    const nextSeq = await runTransaction(db, async (tx) => {
      const snap = await tx.get(counterRef);
      if(!snap.exists()){
        tx.set(counterRef, { seq: 1 });
        return 1;
      }
      const curr = Number(snap.data().seq || 0);
      const next = curr + 1;
      tx.update(counterRef, { seq: next });
      return next;
    });

    const seqStr = String(nextSeq).padStart(3,"0"); // 001,002...
    return `SRRPG-${yyyymm}-${seqStr}`;
  }

  /* ---------------- Form actions ---------------- */
  window.clearForm = function(){
    $("editId").value="";
    $("name").value="";
    $("phone").value="";
    $("room").value="";
    $("sharing").value="2 Sharing";
    $("rent").value="";
    $("dueDay").value="5";
    $("status").value="Active";
    $("notes").value="";
  };

  window.saveTenant = async function(){
    if(!isLoggedIn()){ alert("Admin login first."); return; }

    const id = $("editId").value.trim();
    const name = $("name").value.trim();
    const phone = $("phone").value.trim().replace(/\D/g,'');
    const room = $("room").value.trim();
    const sharing = $("sharing").value;
    const rent = Number($("rent").value||0);
    const dueDay = clamp(Number($("dueDay").value||5),1,28);
    const status = $("status").value;
    const notes = $("notes").value.trim();

    if(!name || phone.length!==10 || !room || !rent){
      alert("Fill Name, 10-digit Phone, Room, Rent.");
      return;
    }

    const payload = { name, phone, room, sharing, rent, dueDay, status, notes };

    try{
      if(id){
        await updateTenant(id, payload);
      } else {
        await addTenant(payload);
      }
      window.clearForm();
      await refresh();
      alert("Saved ✅");
    }catch(e){
      console.error(e);
      alert("Save failed. Check Firestore rules (test mode) or internet.");
      setDbStatusWarn("Error: " + (e?.message || e));
    }
  };

  window.editTenant = function(id){
    if(!isLoggedIn()){ alert("Admin login first."); return; }
    const t = TENANTS.find(x=>x.id===id);
    if(!t) return;
    $("editId").value=t.id;
    $("name").value=t.name || "";
    $("phone").value=t.phone || "";
    $("room").value=t.room || "";
    $("sharing").value=t.sharing || "2 Sharing";
    $("rent").value=t.rent || "";
    $("dueDay").value=t.dueDay || "5";
    $("status").value=t.status || "Active";
    $("notes").value=t.notes || "";
    window.scrollTo({top:0, behavior:"smooth"});
  };

  window.delTenant = async function(id){
    if(!isLoggedIn()){ alert("Admin login first."); return; }
    if(!confirm("Delete this tenant?")) return;
    try{
      await removeTenant(id);
      await refresh();
    }catch(e){
      console.error(e);
      alert("Delete failed. Check Firestore rules.");
      setDbStatusWarn("Error: " + (e?.message || e));
    }
  };

  /* ---------------- WhatsApp templates ---------------- */
  function makeRentReminderMsg(t){
    const tpl = $("msgTpl").value;
    saveTpl(tpl);
    return tpl
      .replaceAll("{name}", t.name ?? "")
      .replaceAll("{room}", t.room ?? "")
      .replaceAll("{rent}", t.rent ?? "")
      .replaceAll("{dueDay}", t.dueDay ?? "");
  }

  function waLinkRent(t){
    const phone = "91" + String(t.phone || "").replace(/\D/g,'');
    const text = encodeURIComponent(makeRentReminderMsg(t));
    return `https://wa.me/${phone}?text=${text}`;
  }

  function waReceiptText(t){
    const mk = t.lastPaidYYYYMM || monthKey();
    const monthTxt = monthLabelFromYYYYMM(mk) || "this month";
    const receiptNo = t.lastReceiptNo || "SRRPG-YYYYMM-001";
    const paidDate = t.lastPaidDate || todayDDMMYYYY();
    const method = t.lastPaidMethod || "UPI";
    return `RENT RECEIPT ✅
PG: ${PG_NAME}
Address: ${PG_ADDRESS}
Name: ${t.name || ""}
Room: ${t.room || ""}
Month: ${monthTxt}
Amount: ₹${t.rent || ""}
Paid Date: ${paidDate}
Payment Method: ${method}
Receipt No: ${receiptNo}

(Receipt PDF attached)`;
  }

  function waLinkReceipt(t){
    const phone = "91" + String(t.phone || "").replace(/\D/g,'');
    const text = encodeURIComponent(waReceiptText(t));
    return `https://wa.me/${phone}?text=${text}`;
  }

  /* ---------------- Paid + Receipt ---------------- */
  async function toDataURL(url){
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error("Logo fetch failed: " + res.status);
    const blob = await res.blob();
    return await new Promise((resolve)=>{
      const reader = new FileReader();
      reader.onload = ()=>resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  }

  window.markPaid = async function(id){
    if(!isLoggedIn()){ alert("Admin login first."); return; }
    const t = TENANTS.find(x=>x.id===id);
    if(!t) return;

    const mk = prompt("Paid month (YYYYMM). Example: 202601", t.lastPaidYYYYMM || monthKey());
    if(!mk) return;
    if(!/^\d{6}$/.test(mk)){ alert("Invalid month format. Use YYYYMM like 202601"); return; }

    const paidDate = prompt("Paid date (DD/MM/YYYY)", t.lastPaidDate || todayDDMMYYYY());
    if(!paidDate) return;

    const method = prompt("Payment method (Cash / UPI / Bank)", t.lastPaidMethod || "UPI");
    if(!method) return;

    try{
      // Monthly sequential receipt no
      const receiptNo = await getNextReceiptNumber(mk);

      await updateTenant(id, {
        lastPaidYYYYMM: mk,
        lastPaidDate: paidDate,
        lastPaidMethod: method,
        lastReceiptNo: receiptNo
      });

      await refresh();
      alert("Marked paid ✅ Receipt No: " + receiptNo + " (Now click Receipt PDF)");
    }catch(e){
      console.error(e);
      alert("Mark paid failed. Check Firestore rules.");
      setDbStatusWarn("Error: " + (e?.message || e));
    }
  };

  window.generateReceiptPDF = async function(id){
    if(!isLoggedIn()){ alert("Admin login first."); return; }
    const t = TENANTS.find(x=>x.id===id);
    if(!t) return;

    if(!t.lastPaidYYYYMM){
      alert("First click Mark Paid, then generate receipt.");
      return;
    }

    const mk = t.lastPaidYYYYMM;
    const monthTxt = monthLabelFromYYYYMM(mk) || "Month";
    const receiptNo = t.lastReceiptNo || "SRRPG-YYYYMM-001";
    const paidDate = t.lastPaidDate || todayDDMMYYYY();
    const method = t.lastPaidMethod || "UPI";
    const amount = t.rent || "";

    const { jsPDF } = window.jspdf || {};
    if(!jsPDF){
      alert("PDF library not loaded. Refresh page and try again.");
      return;
    }

    const docPdf = new jsPDF({ unit:"pt", format:"a4" });

    const marginX = 40;
    let y = 45;

    // Header box
    docPdf.setDrawColor(220);
    docPdf.setFillColor(248, 250, 252);
    docPdf.roundedRect(marginX, y, 515, 90, 10, 10, "FD");

    // Logo (optional)
    try{
      const logoData = await toDataURL(LOGO_PATH);
      // if PNG, use "PNG"
      docPdf.addImage(logoData, "PNG", marginX+12, y+12, 66, 66);
    }catch(e){
      // if logo missing, ignore
    }

    // Title
    docPdf.setFont("helvetica","bold");
    docPdf.setFontSize(16);
    docPdf.text(PG_NAME, marginX+90, y+30);

    docPdf.setFont("helvetica","normal");
    docPdf.setFontSize(10);
    docPdf.text(PG_ADDRESS, marginX+90, y+50, { maxWidth: 440 });

    docPdf.setFont("helvetica","bold");
    docPdf.setFontSize(13);
    docPdf.text("RENT RECEIPT", marginX+90, y+75);

    y += 120;

    // Details
    docPdf.setFont("helvetica","bold"); docPdf.setFontSize(11);
    docPdf.text("Receipt No:", marginX, y);
    docPdf.setFont("helvetica","normal");
    docPdf.text(String(receiptNo), marginX+95, y);

    y += 18;
    docPdf.setFont("helvetica","bold");
    docPdf.text("Paid Date:", marginX, y);
    docPdf.setFont("helvetica","normal");
    docPdf.text(String(paidDate), marginX+95, y);

    y += 18;
    docPdf.setFont("helvetica","bold");
    docPdf.text("Month:", marginX, y);
    docPdf.setFont("helvetica","normal");
    docPdf.text(String(monthTxt), marginX+95, y);

    y += 22;
    docPdf.setDrawColor(235);
    docPdf.line(marginX, y, 555, y);

    y += 24;
    docPdf.setFont("helvetica","bold");
    docPdf.text("Tenant Name:", marginX, y);
    docPdf.setFont("helvetica","normal");
    docPdf.text(String(t.name || ""), marginX+95, y);

    y += 18;
    docPdf.setFont("helvetica","bold");
    docPdf.text("Phone:", marginX, y);
    docPdf.setFont("helvetica","normal");
    docPdf.text(String(t.phone || ""), marginX+95, y);

    y += 18;
    docPdf.setFont("helvetica","bold");
    docPdf.text("Room:", marginX, y);
    docPdf.setFont("helvetica","normal");
    docPdf.text(String(t.room || ""), marginX+95, y);

    y += 18;
    docPdf.setFont("helvetica","bold");
    docPdf.text("Sharing:", marginX, y);
    docPdf.setFont("helvetica","normal");
    docPdf.text(String(t.sharing || ""), marginX+95, y);

    y += 18;
    docPdf.setFont("helvetica","bold");
    docPdf.text("Amount Paid:", marginX, y);
    docPdf.setFont("helvetica","normal");
    docPdf.text(`₹${amount}`, marginX+95, y);

    y += 18;
    docPdf.setFont("helvetica","bold");
    docPdf.text("Payment Method:", marginX, y);
    docPdf.setFont("helvetica","normal");
    docPdf.text(String(method), marginX+110, y);

    y += 26;
    docPdf.setDrawColor(235);
    docPdf.line(marginX, y, 555, y);

    // Footer stamp-like box
    y += 26;
    docPdf.setDrawColor(200);
    docPdf.setFillColor(255, 255, 255);
    docPdf.roundedRect(marginX, y, 515, 110, 10, 10, "FD");

    docPdf.setFont("helvetica","bold");
    docPdf.setFontSize(12);
    docPdf.text("Authorized Stamp", marginX+18, y+28);

    docPdf.setFont("helvetica","normal");
    docPdf.setFontSize(10);
    docPdf.text(PG_NAME, marginX+18, y+48);
    docPdf.text(PG_ADDRESS, marginX+18, y+64, { maxWidth: 320 });

    docPdf.setFont("helvetica","normal");
    docPdf.setFontSize(10);
  // Authorized signature + PG seal block
docPdf.setFont("helvetica","normal");
docPdf.setFontSize(10);

// signature line
docPdf.line(410, y+70, 555, y+70);

// label
docPdf.text("Authorized Signatory", 410, y+85);

// name under signature
docPdf.setFont("helvetica","bold");
docPdf.setFontSize(11);
docPdf.text("V Chakradhar", 410, y+102);

// ---- ROUND PG SEAL (LEFT SIDE) ----
try {
  const sealData = await toDataURL("seal.png");
  docPdf.addImage(sealData, "PNG", 330, y+38, 70, 70, undefined, "FAST");
} catch (e) {
  docPdf.setDrawColor(150);
  docPdf.circle(365, y+72, 32);
  docPdf.setFont("helvetica","bold");
  docPdf.setFontSize(9);
  docPdf.text("SRI", 353, y+66);
  docPdf.text("RAJARAJESWARI", 330, y+78);
  docPdf.text("PG", 360, y+92);
}


    y += 140;
    docPdf.setFontSize(9);
    docPdf.text("This is a computer-generated receipt.", marginX, y);

    const filename = `${PG_NAME.replace(/\s+/g,'_')}_Receipt_${receiptNo}.pdf`;
    docPdf.save(filename);
  };

  /* ---------------- Table render ---------------- */
  window.renderTable = function(){
    const tplBox = $("msgTpl");
    if(!tplBox.value) tplBox.value = loadTpl();

    const q = ($("q").value || "").toLowerCase().trim();
    const filter = $("filter").value;

    let list = [...TENANTS];

    if(filter !== "All"){
      list = list.filter(x=> (x.status||"") === filter);
    }
    if(q){
      list = list.filter(x =>
        (x.name||"").toLowerCase().includes(q) ||
        (x.room||"").toLowerCase().includes(q) ||
        String(x.phone||"").includes(q)
      );
    }

    const tbl = $("tbl");
    if(list.length===0){
      tbl.innerHTML = `<tr><td class="muted">No tenants found. Add tenants (admin login) or click Refresh.</td></tr>`;
      return;
    }

    tbl.innerHTML = `
      <tr>
        <th>Tenant</th><th>Room</th><th>Rent</th><th>Due</th><th>Status</th><th>Last Paid</th><th>WhatsApp</th><th>Actions</th>
      </tr>
    `;

    list.forEach(t=>{
      const lp = t.lastPaidYYYYMM ? `${monthLabelFromYYYYMM(t.lastPaidYYYYMM)} (${esc(t.lastPaidDate||"")})` : "—";
      const receiptEnabled = !!t.lastPaidYYYYMM;

      tbl.innerHTML += `
        <tr>
          <td><b>${esc(t.name)}</b><div class="muted">${esc(t.phone)}<br>${esc(t.notes||"")}</div></td>
          <td>${esc(t.room)}<div class="muted">${esc(t.sharing||"")}</div></td>
          <td>₹${Number(t.rent||0).toLocaleString()}</td>
          <td>${esc(t.dueDay||"")}</td>
          <td><span class="pill">${esc(t.status||"")}</span></td>
          <td>${lp}<div class="muted">${esc(t.lastPaidMethod||"")}</div><div class="muted">${esc(t.lastReceiptNo||"")}</div></td>
          <td>
            <a href="${waLinkRent(t)}" target="_blank">Rent Reminder</a><br/>
            <a href="${waLinkReceipt(t)}" target="_blank">Receipt Msg</a>
            <div class="muted">Attach PDF manually</div>
          </td>
          <td>
            <div class="actions">
              <button class="gray" onclick="editTenant('${t.id}')">Edit</button>
              <button class="black" onclick="markPaid('${t.id}')">Mark Paid</button>
              <button class="white" onclick="generateReceiptPDF('${t.id}')" ${receiptEnabled ? "" : "disabled"}>Receipt PDF</button>
              <button class="danger" onclick="delTenant('${t.id}')">Delete</button>
            </div>
            <div class="muted">Receipt PDF enabled after Mark Paid</div>
          </td>
        </tr>
      `;
    });
  };

  /* ---------------- Refresh / Export / Import ---------------- */
  window.refresh = async function(){
    try{
      await fetchTenants();
      setDbStatusOk("Connected ✅ Tenants loaded: " + TENANTS.length);
      renderTable();
    }catch(e){
      console.error(e);
      setDbStatusWarn("Cannot read tenants. Check Firestore rules (test mode) and internet. Error: " + (e?.message || e));
    }
  };

  window.exportJSON = function(){
    const data = JSON.stringify(TENANTS, null, 2);
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "tenants-export.json";
    a.click();
    URL.revokeObjectURL(url);
  };

  window.importJSON = async function(){
    if(!isLoggedIn()){ alert("Admin login first."); return; }

    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "application/json";
    inp.onchange = async () => {
      const file = inp.files?.[0];
      if(!file) return;
      const text = await file.text();
      let arr;
      try{ arr = JSON.parse(text); }catch(e){ alert("Invalid JSON file."); return; }
      if(!Array.isArray(arr)){ alert("JSON must be an array of tenants."); return; }
      if(!confirm("This will ADD tenants from file (won't delete existing). Continue?")) return;

      try{
        for(const t of arr){
          const payload = {
            name: String(t.name||"").trim(),
            phone: String(t.phone||"").replace(/\D/g,''),
            room: String(t.room||"").trim(),
            sharing: t.sharing || "2 Sharing",
            rent: Number(t.rent||0),
            dueDay: clamp(Number(t.dueDay||5),1,28),
            status: t.status || "Active",
            notes: String(t.notes||"").trim(),
            lastPaidYYYYMM: String(t.lastPaidYYYYMM||"").trim(),
            lastPaidDate: String(t.lastPaidDate||"").trim(),
            lastPaidMethod: String(t.lastPaidMethod||"").trim(),
            lastReceiptNo: String(t.lastReceiptNo||"").trim()
          };
          if(!payload.name || payload.phone.length!==10 || !payload.room || !payload.rent) continue;
          await addTenant(payload);
        }
        await refresh();
        alert("Import done ✅");
      }catch(e){
        console.error(e);
        alert("Import failed. Check Firestore rules.");
        setDbStatusWarn("Error: " + (e?.message || e));
      }
    };
    inp.click();
  };

  window.seedSample = async function(){
    if(!isLoggedIn()){ alert("Admin login first."); return; }
    if(!confirm("Add 2 sample tenants to DB?")) return;
    try{
      await addTenant({ name:"Ravi", phone:"9000000001", room:"A-101", sharing:"2 Sharing", rent:6500, dueDay:5, status:"Active", notes:"" });
      await addTenant({ name:"Sita", phone:"9000000002", room:"B-201", sharing:"4 Sharing", rent:4500, dueDay:10, status:"Active", notes:"" });
      await refresh();
    }catch(e){
      console.error(e);
      alert("Failed to add sample. Check Firestore rules.");
      setDbStatusWarn("Error: " + (e?.message || e));
    }
  };

  /* ---------------- Init ---------------- */
  renderSession();
  $("msgTpl").value = loadTpl();
  await refresh();
</script>
</body>
</html>
